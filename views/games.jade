extends layout

block content
  br
  ul.nav.nav-pills
    if heading === 'Top 25'
      li.active
        a(href='/games') Top 25
    else
      li
        a(href='/games') Top 25

    if heading === 'Action'
      li.active
        a(href='/games/genre/action') Action
    else
      li
        a(href='/games/genre/action') Action

    if heading === 'Adventure'
      li.active
        a(href='/games/genre/adventure') Adventure
    else
      li
        a(href='/games/genre/adventure') Adventure

    if heading === 'Fighting'
      li.active
        a(href='/games/genre/fighting') Fighting
    else
      li
        a(href='/games/genre/fighting') Fighting

    if heading === 'MMO'
      li.active
        a(href='/games/genre/mmo') MMO
    else
      li
        a(href='/games/genre/mmo') MMO

    if heading === 'Puzzle'
      li.active
        a(href='/games/genre/puzzle') Puzzle
    else
      li
        a(href='/games/genre/puzzle') Puzzle

    if heading === 'Racing'
      li.active
        a(href='/games/genre/racing') Racing
    else
      li
        a(href='/games/genre/racing') Racing

    if heading === 'Role-Playing'
      li.active
        a(href='/games/genre/role-playing') Role-Playing
    else
      li
        a(href='/games/genre/role-playing') Role-Playing

    if heading === 'Simulation'
      li.active
        a(href='/games/genre/simulation') Simulation
    else
      li
        a(href='/games/genre/simulation') Simulation

    if heading === 'Strategy'
      li.active
        a(href='/games/genre/strategy') Strategy
    else
      li
        a(href='/games/genre/strategy') Strategy

    if heading === 'Sports'
      li.active
        a(href='/games/genre/sports') Sports
    else
      li
        a(href='/games/genre/sports') Sports


  if games.length == 0
    .alert.alert-warning
      | Database query returned no results.
  else
    table.table
          tbody
            for game in games
              .modal.hide.fade(id='modal-#{game.slug}', tabindex='-1', role='dialog', aria-labelledby='myModalLabel', aria-hidden='true')
                .modal-header
                  span.lead Game Checkout
                    img.pull-right(src='/img/new_visa_medium.gif')
                .modal-body
                  label
                    i.icon-user
                    |  Name on Card
                  input.input-medium(type='text')
                  label
                    i.icon-barcode
                    |  Card Number
                  input.input-medium(type='text', placeholder='•••• •••• •••• ••••', maxlength=16)

                  label
                    i.icon-time
                    |  Expiration Date
                  input.input-mini(type='text', placeholder='MMYY', maxlength=4)
                  label
                    i.icon-qrcode
                    |  Card Code
                  input.input-mini(type='text', placeholder='CVC', maxlength=4)
                .modal-footer
                  button.btn(data-dismiss='modal', aria-hidden='true') Cancel
                  button.btn.btn-primary(id='#{game.slug}') Buy
              tr
                td.span2
                  img.img-polaroid(src=game.thumbnail)
                td
                  a(href='/games/#{game.slug}')
                    strong
                      = game.title
                  button.btn.btn-primary.btn-mini(id='price-#{game.slug}', href='#modal-#{game.slug}', role='button', data-toggle='modal')
                    i.icon-shopping-cart.icon-white
                    =  game.price
                  if user.userName
                    if user.purchasedGames.length > 0
                      for mygame in user.purchasedGames
                        if mygame.slug == game.slug
                          script(type='text/javascript')
                            $('#price-#{game.slug}').removeAttr('href');
                            $('#price-#{game.slug}').html('<i class="icon-shopping-cart icon-white"></i> Purchased');
                  div
                    span(id='_' + game.slug)
                    span(id='votes', name='votes')
                    |  (#{game.votes} votes)
                  div
                    small.muted
                      div #{game.releaseDate} | #{game.publisher}
                      div #{game.genre}
                  p
                    =game.description
              if typeof(user.userName) != 'undefined'
                if game.votedPeople.length != 0
                  for voter in game.votedPeople
                    if voter == user.userName || user.suspendedRating
                      script(type='text/javascript')
                        $('#_#{game.slug}').raty({
                          path: '/img/',
                          round : { down: .25, full: .6, up: .76 },
                          score: #{game.rating}/#{game.votes},
                          readOnly: true
                        });
                    else
                      script(type='text/javascript')
                        $('#_#{game.slug}').raty({
                          path: '/img/',
                          round : { down: .25, full: .6, up: .76 },
                          score: #{game.rating}/#{game.votes},
                          readOnly: false,
                          click: function (score, event) {
                            var self = this;
                            $.meow({
                              message: 'Thanks for voting. Your rating has been recorded.',
                              icon: 'http://png-3.findicons.com/files/icons/1577/danish_royalty_free/32/smiley.png'
                            });
                            $.ajax({
                              type: 'POST',
                              url: '/games/rating',
                              data: {
                                slug: $(self).attr('id').slice(1),
                                rating: score
                              },
                              success: function () {
                                console.log('setting to read-only');
                                $(self).raty('readOnly', true);
                              }
                            });
                          }
                        });
                else
                  script(type='text/javascript')
                    $('#_#{game.slug}').raty({
                          path: '/img/',
                          round : { down: .25, full: .6, up: .76 },
                          score: #{game.rating}/#{game.votes},
                          readOnly: false,
                          click: function (score, event) {
                            var self = this;
                            $.meow({
                              message: 'Thanks for voting. Your rating has been recorded.',
                              icon: 'http://png-3.findicons.com/files/icons/1577/danish_royalty_free/32/smiley.png'
                            });
                            $.ajax({
                              type: 'POST',
                              url: '/games/rating',
                              data: {
                                slug: $(self).attr('id').slice(1),
                                rating: score
                              },
                              success: function () {
                                console.log('setting to read-only');
                                $(self).raty('readOnly', true);
                              }
                            });
                          }
                        });
              else
                script(type='text/javascript')
                  $('#_#{game.slug}').raty({
                    round : { down: .25, full: .6, up: .76 },
                    score: #{game.rating}/#{game.votes},
                    readOnly: true
                  });

              script(type='text/javascript')
                $('##{game.slug}').click(function() {
                  var game = this;
                  $.ajax({
                    type: 'post',
                    url: '/buy',
                    data:  {
                      slug: $(game).attr('id')
                    }
                  }).success(function () {
                    $('#price-#{game.slug}').attr('disabled', 'true');
                    $('#modal-' + $(game).attr('id')).modal('hide');
                    humane.log('Your order has been submitted!');
                  });
                });