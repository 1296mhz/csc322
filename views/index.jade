extends layout
block content
  .page-header
    p.lead#welcome
      if user.firstName
        strong Welcome #{user.firstName},
        small  here's the top 6 recommended games for you
        br
        small.muted How it works: 
        small
          | First 3 games are based on your interests, the last 3 games are
          | based on your game purchases
      else
        strong Welcome Visitor,
        small  here's the top 3 most popular games for you
  
  .row 
    // remove later

    // make sure user is logged in
    if user.userName
      // if user hasn't entered any interests, although he shouldn't even be on this page
      if interestGames6.length == 0
        .alert.alert-warning
          div Database query returned no results that match your interests.
      else
        // if user hasn't purchased 3 games yet, display 6 games based on interest
        if user.purchasedGames.length < 3
          for game in interestGames6
            .span2
              img.img-polaroid.medium(src='/img/games/#{game.largeImage}')
              br
              strong
                a(href='/games/#{game.slug}') #{game.title}
              div
                span(id='_' + game.slug)
                span(id='votes', name='votes')
                  small  (#{game.votes})
                br
                strong #{game.price}

              script(type='text/javascript')
                $('#_#{game.slug}').raty({
                  path: '/img/',
                  round: { down: .25, full: .6, up: .76 },
                  score: #{game.rating}/#{game.votes},
                  space: false,
                  readOnly: true,
                  click: function (score, event) {
                    var self = this;
                    $.meow({
                      message: 'Thanks for voting. Your rating has been recorded.',
                      icon: 'http://png-3.findicons.com/files/icons/1577/danish_royalty_free/32/smiley.png'
                    });

                    $.ajax({
                      type: 'POST',
                      url: '/games/rating',
                      data: {
                        slug: $(self).attr('id').slice(1),
                        rating: score
                      },
                      success: function () {
                        console.log('setting to read-only');
                        $(self).raty('readOnly', true);

                      }
                    });
                  }
                });
        else
          // otherwise user has purchased at least 3 games so display 3 games
          // based on interest and 3 games based on purchased games
          for game in interestGames3
            .span2
              img.img-polaroid.medium(src='/img/games/#{game.largeImage}')
              br
              strong
                a(href='/games/#{game.slug}') #{game.title}
              div
                span(id='_' + game.slug)
                span(id='votes', name='votes')
                  small  (#{game.votes})
                br
                strong #{game.price}

              script(type='text/javascript')
                $('#_#{game.slug}').raty({
                  path: '/img/',
                  round: { down: .25, full: .6, up: .76 },
                  score: #{game.rating}/#{game.votes},
                  space: false,
                  readOnly: true,
                  click: function (score, event) {
                    var self = this;
                    $.meow({
                      message: 'Thanks for voting. Your rating has been recorded.',
                      icon: 'http://png-3.findicons.com/files/icons/1577/danish_royalty_free/32/smiley.png'
                    });

                    $.ajax({
                      type: 'POST',
                      url: '/games/rating',
                      data: {
                        slug: $(self).attr('id').slice(1),
                        rating: score
                      },
                      success: function () {
                        console.log('setting to read-only');
                        $(self).raty('readOnly', true);

                      }
                    });
                  }
                });

          for game in purchasedGames
              .span2
                img.img-polaroid.medium(src='/img/games/#{game.largeImage}')
                br
                strong
                  a(href='/games/#{game.slug}') #{game.title}
                div
                  span(id='_' + game.slug)
                  span(id='votes', name='votes')
                    small  (#{game.votes})
                  br
                  strong #{game.price}

                script(type='text/javascript')
                  $('#_#{game.slug}').raty({
                    path: '/img/',
                    round: { down: .25, full: .6, up: .76 },
                    score: #{game.rating}/#{game.votes},
                    space: false,
                    readOnly: true,
                    click: function (score, event) {
                      var self = this;
                      $.meow({
                        message: 'Thanks for voting. Your rating has been recorded.',
                        icon: 'http://png-3.findicons.com/files/icons/1577/danish_royalty_free/32/smiley.png'
                      });

                      $.ajax({
                        type: 'POST',
                        url: '/games/rating',
                        data: {
                          slug: $(self).attr('id').slice(1),
                          rating: score
                        },
                        success: function () {
                          console.log('setting to read-only');
                          $(self).raty('readOnly', true);

                        }
                      });
                    }
                  });

    else
      if games.length == 0
        .alert.alert-warning
          | Database query returned no results.
      else
        for game in games
          .span4
            img.img-polaroid.large(src='/img/games/#{game.largeImage}')
            h4
              a(href='/games/#{game.slug}') #{game.title}
            span(id='_' + game.slug)
            span(id='votes', name='votes')
              |  (#{game.votes})
            br
            h4 #{game.price}

            script(type='text/javascript')
              $('#_#{game.slug}').raty({
                round : { down: .25, full: .6, up: .76 },
                score: #{game.rating}/#{game.votes},
                readOnly: true,
                click: function (score, event) {
                  var self = this;
                  $.meow({
                    message: 'Thanks for voting. Your rating has been recorded.',
                    icon: 'http://png-3.findicons.com/files/icons/1577/danish_royalty_free/32/smiley.png'
                  });

                  $.ajax({
                    type: 'POST',
                    url: '/games/rating',
                    data: {
                      slug: $(self).attr('id').slice(1),
                      rating: score
                    },
                    success: function () {
                      console.log('setting to read-only');
                      $(self).raty('readOnly', true);

                    }
                  });
                }
              });
